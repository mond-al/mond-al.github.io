<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Scoped Storage 적용하기</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- awesome font   -->
    <script src="https://kit.fontawesome.com/09fc514f86.js" crossorigin="anonymous"></script>
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="generator" content="Jekyll 3.6.2"/>
<meta name="description" content="몬드는 오늘도 개발을 합니다. 내일도..."/>
<link rel="shortcut icon" href="https://mond-al.github.io/assets/images/fav/favicon-96x96.png" type="image/png"/>
<link rel="canonical" href="https://mond-al.github.io/scoped-storage"/>
<link rel="alternate" type="application/rss+xml" href="https://mond-al.github.io/rss.xml">
<meta name="referrer" content="no-referrer-when-downgrade"/>
<meta name="google-site-verification" content="GCZr_aYYwDvGhBvJNkNJft6FY0cIWqpS9Zce3sPH784"/>

<title> Scoped Storage 적용하기</title>

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Scoped Storage 적용하기 | 몬드의 개발로그</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Scoped Storage 적용하기" />
<meta name="author" content="jisoo Yang" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="아마도 Scoped Storage를 강제하는 부분인 Android 11(R)에서 가장 큰 변화인 것 같습니다." />
<meta property="og:description" content="아마도 Scoped Storage를 강제하는 부분인 Android 11(R)에서 가장 큰 변화인 것 같습니다." />
<link rel="canonical" href="https://mond-al.github.io/scoped-storage" />
<meta property="og:url" content="https://mond-al.github.io/scoped-storage" />
<meta property="og:site_name" content="몬드의 개발로그" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-01T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Scoped Storage 적용하기" />
<script type="application/ld+json">
{"headline":"Scoped Storage 적용하기","url":"https://mond-al.github.io/scoped-storage","dateModified":"2021-02-01T00:00:00+09:00","datePublished":"2021-02-01T00:00:00+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mond-al.github.io/scoped-storage"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://mond-al.github.io/assets/images/logo/normal_icon.png"},"name":"jisoo Yang"},"author":{"@type":"Person","name":"jisoo Yang"},"description":"아마도 Scoped Storage를 강제하는 부분인 Android 11(R)에서 가장 큰 변화인 것 같습니다.","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<meta property="og:image" content="https://mond-al.github.io/assets/images/cover/common_android.jpg"/>
 <meta property="og:image:width" content="800"/> <meta property="og:image:height" content="540"/> 
<meta property="article:publisher" content="https://www.facebook.com/jisoo.yang.56"/>





</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->
<!-- awesome font   -->
<script src="https://kit.fontawesome.com/09fc514f86.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/assets/built/syntax.css">
<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://mond-al.github.io/"><img src="/assets/images/logo/normal_icon.png" alt="몬드의 개발로그" /></a>
            
        
        
            <!--메뉴 네비바 -->
<ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-getting-started" role="menuitem"><a href="/tag/android/">Android</a></li>
    <li class="nav-try-ghost" role="menuitem"><a href="#search">Search</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-fb" href="https://facebook.com/jisoo.yang.56" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
</a>
            
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-android tag-sdkversion30 tag-scoped-storage  ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime=" 1 February 2021"> 1 February 2021</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/android/'>ANDROID</a>,
                            
                        
                            
                               <a href='/tag/sdkversion30/'>SDKVERSION30</a>,
                            
                        
                            
                               <a href='/tag/scoped-storage/'>SCOPED STORAGE</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Scoped Storage 적용하기</h1>
            </header>

<!--        본문 상단 커버이미지-->
<!--            -->
<!--            <figure class="post-full-image" style="background-image: url(/assets/images/cover/common_android.jpg)">-->
<!--            </figure>-->
<!--            -->

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>아마도 Scoped Storage를 강제하는 부분인 Android 11(R)에서 가장 큰 변화인 것 같습니다.</p>

<h2 id="scoped-storage-적용">Scoped Storage 적용</h2>

<p>Android 10(Q) 발표당시 안드로이드 개발자를 공포로 몰아넣었던 <code class="language-plaintext highlighter-rouge">Scoped Storage</code>의 유예기간이 종료되었습니다. targetSdkVersion 29를 적용할때 <code class="language-plaintext highlighter-rouge">Scoped Storage</code>를 무시할 수 있도록 제공된 <code class="language-plaintext highlighter-rouge">requestLegacyExternalStorage</code>는 targetSdkVersion 30이 적용되면 Android 11(R) 이상 디바이스에서 무시됩니다. <a href="https://developer.android.com/about/versions/11/privacy/storage?hl=ko#scoped-storage"><i class="fas fa-link"></i></a></p>

<p>대신 또 다른 일회성 예외가 추가되었습니다. <code class="language-plaintext highlighter-rouge">preserveLegacyExternalStorage</code>라는 플래그입니다. 이 플래그를 적용하면, <code class="language-plaintext highlighter-rouge">기존</code>에 사용하던 파일을 이전 할 수 있도록 예외처리됩니다. 하지만 첫 설치 또는 앱 삭제후 재설치한 경우에는 예외가 적용되지 않습니다.<a href="https://developer.android.com/training/data-storage/use-cases?hl=ko#if_your_app_targets"><i class="fas fa-link"></i></a></p>

<p>Android 9(O,Oreo)이전까지 개발자들은 <code class="language-plaintext highlighter-rouge">"WRITE_EXTERNAL_STORAGE"</code>권한 하나만 얻으면 뭐든 할 수 있었습니다. external storage의 루트에
자기앱이름을 따서 폴더를 만들어서 갤러리에 보여줄 파일을 다운받거나 생성하기도 하고, 그 하위나 또 다른 은밀한?곳에 <code class="language-plaintext highlighter-rouge">"."(dot)</code>으로 시작하는 폴더와 <code class="language-plaintext highlighter-rouge">".nomedia"</code> 파일을 이용해서 (사용자 몰래) 파일을 생성한 경험이 있을 것 입니다. <i class="fas fa-flushed"></i></p>

<h3 id="targetsdkversion-30-을-적용하는-순간-write_external_storage는-완전히-무시됩니다">targetSdkVersion 30 을 적용하는 순간 <code class="language-plaintext highlighter-rouge">WRITE_EXTERNAL_STORAGE</code>는 완전히 무시됩니다.<a href="https://developer.android.com/about/versions/11/privacy/storage?hl=ko#permissions-target-11"><i class="fas fa-link"></i></a></h3>

<p>지금까지는 <code class="language-plaintext highlighter-rouge">WRITE_EXTERNAL_STORAGE</code>을 요청하고 승인받으면, 자동으로 <code class="language-plaintext highlighter-rouge">READ_EXTERNAL_STORAGE</code>를 획득 할 수 있었기 때문에 <code class="language-plaintext highlighter-rouge">READ_EXTERNAL_STORAGE</code>를 암묵적으로 따로 처리 하지 않은 경우를 많이 찾아 볼 수 있었습니다.  <br />
이런 경우 <code class="language-plaintext highlighter-rouge">onRequestPermissionsResult</code>에서 <code class="language-plaintext highlighter-rouge">WRITE_EXTERNAL_STORAGE</code>는 항상 <code class="language-plaintext highlighter-rouge">PERMISSION_DENIED</code>를 반환하기 때문에, 계속 사용자에게 권한을 요청하는 교착상태에 빠질 수 있습니다.</p>

<blockquote>
  <p>정리 : 앱 외부공간에 파일에 접근 할 일이 있다면, 안드로이드 Q미만에서는 <code class="language-plaintext highlighter-rouge">WRITE_EXTERNAL_STORAGE</code>와 <code class="language-plaintext highlighter-rouge">READ_EXTERNAL_STORAGE</code>를 구분하여 적절히 사용하고 Q이상에서는 <code class="language-plaintext highlighter-rouge">READ_EXTERNAL_STORAGE</code>만 요청하도록 분기해야 합니다.</p>
</blockquote>

<blockquote>
  <p>정리 : <code class="language-plaintext highlighter-rouge">requestLegacyExternalStorage</code>를 적용하면 Android 10 디바이스에서 <code class="language-plaintext highlighter-rouge">WRITE_EXTERNAL_STORAGE</code>를 계속 사용 할 수 있지만 <code class="language-plaintext highlighter-rouge">maxSdkVersion="28"</code>을 명시하여 Q미만과 Q이상으로 구분하는 것이 좋을 것 같습니다. 결국은 사용자의 환경은 Android 11로 넘어 갈 것이고 <code class="language-plaintext highlighter-rouge">Scoped Storage</code>대응을 미루어야 할 이유는 없습니다.</p>
</blockquote>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.WRITE_EXTERNAL_STORAGE"</span>
                 <span class="na">android:maxSdkVersion=</span><span class="s">"28"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>매번 이야기 하기가 번거롭기 때문에 용어를 정리하겠습니다. <code class="language-plaintext highlighter-rouge">Scoped Storage 적용된 상태</code>라는 말은 targetSdkVersion 29에서 requestLegacyExternalStorage를 사용하지 않았거나 targetSdkVersion 30을 적용한 앱을 Android 10 단말에서 사용하는 상태를 말합니다.</p>

<h3 id="private-영역의-파일-쓰기는-동일합니다">private 영역의 파일 쓰기는 동일합니다.</h3>

<p>아래처럼 앱 영역(apps’ private directories)에 파일을 생성하는데 제한은 없습니다.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">path</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="nf">getDir</span><span class="p">(</span><span class="s">"tmp"</span><span class="p">,</span> <span class="nc">Context</span><span class="p">.</span><span class="nc">MODE_PRIVATE</span><span class="p">).</span><span class="nf">getPath</span><span class="p">()</span>
<span class="o">....</span>
<span class="nc">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> 
</code></pre></div></div>

<h3 id="public한-파일-생성과-쓰기-방법이-변경-되었습니다">public한 파일 생성과 쓰기 방법이 변경 되었습니다.</h3>

<p><code class="language-plaintext highlighter-rouge">Scoped Storage 적용되지 않은 상태</code>에서는 아래처럼 메모리카드 루트폴더에 폴더를 생성하고 파일쓰기가 가능했지만, <code class="language-plaintext highlighter-rouge">Scoped Storage 적용된 상태</code>에서는 WRITE_EXTERNAL_STORAGE가 허용되지 않으니 Scoped Storage가 적용 된 상태라면 아래의 코드는 파일을 생성 할 수 없습니다. 아마도 <code class="language-plaintext highlighter-rouge">open failed: ENOENT (No such file or directory)</code> 같은 에러가 발생할 것 입니다.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">path</span> <span class="p">=</span> <span class="nc">Environment</span><span class="p">.</span><span class="nf">getExternalStorageDirectory</span><span class="p">().</span><span class="nf">getAbsolutePath</span><span class="p">()</span> <span class="p">+</span> <span class="s">"/tmp"</span>
<span class="o">....</span>
<span class="nc">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span> 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Scoped Storage 적용되지 않은 상태</code>에서는 새롭게 생성한 이미지나 미디어 파일를 갤러리앱에 노출하기 위해서는 아래처럼 contentResolver를 이용해 파일을 등록하도록 하였습니다. 코드의 문맥을 보면 파일의 절대경로는 별도로 존재하고 DB에 해당 파일의 row를 추가하는 형태 였습니다. <code class="language-plaintext highlighter-rouge">Scoped Storage 적용된 상태</code>에서 <code class="language-plaintext highlighter-rouge">MediaStore</code>를 이용하여 이미지,비디오,오디오,다운로된 파일의 경로에 추가 하기 위해서는 아래의 코드 처럼 작성해야 합니다.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ContentValues</span> <span class="n">contentValues</span><span class="p">=</span><span class="n">new</span> <span class="nc">ContentValues</span><span class="p">()</span>
<span class="n">contentValues</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nc">MediaStore</span><span class="p">.</span><span class="nc">Images</span><span class="p">.</span><span class="nc">Media</span><span class="p">.</span><span class="nc">IS_PENDING</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>   <span class="c1">// I/O는 오래 걸리니... 일단 PENDING 시켜놓고</span>
<span class="n">contentValues</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nc">MediaStore</span><span class="p">.</span><span class="nc">Images</span><span class="p">.</span><span class="nc">Media</span><span class="p">.</span><span class="nc">RELATIVE_PATH</span><span class="p">,</span><span class="nc">Environment</span><span class="p">.</span><span class="nc">DIRECTORY_PICTURES</span><span class="p">)</span> <span class="c1">// 경로를 결정합니다.</span>
<span class="o">....</span>
<span class="kd">val</span> <span class="py">uri</span><span class="p">=</span><span class="nf">getContentResolver</span><span class="p">().</span><span class="nf">insert</span><span class="p">(</span><span class="nc">MediaStore</span><span class="p">.</span><span class="nc">Images</span><span class="p">.</span><span class="nc">Media</span><span class="p">.</span><span class="nc">EXTERNAL_CONTENT_URI</span><span class="p">,</span><span class="n">contentValues</span><span class="p">)</span>
<span class="nf">getContentResolver</span><span class="p">().</span><span class="nf">openFileDescriptor</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span><span class="s">"w"</span><span class="p">).</span><span class="nf">use</span><span class="p">{</span>    <span class="c1">// 앞서 얻은 uri와 ContentResolver를 이용해서 접근하도록 합시다.</span>
<span class="kd">val</span> <span class="py">outputStream</span><span class="p">=</span><span class="nc">FileOutputStream</span><span class="p">(</span><span class="n">it</span><span class="o">!!</span><span class="p">.</span><span class="nf">getFileDescriptor</span><span class="p">())</span>
<span class="o">..</span><span class="p">.</span>
<span class="n">outputStream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">contentValues</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
<span class="n">contentValues</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nc">MediaStore</span><span class="p">.</span><span class="nc">Images</span><span class="p">.</span><span class="nc">Media</span><span class="p">.</span><span class="nc">SIZE</span><span class="p">,</span><span class="n">file</span><span class="p">.</span><span class="nf">length</span><span class="p">())</span>
<span class="n">contentValues</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nc">MediaStore</span><span class="p">.</span><span class="nc">Images</span><span class="p">.</span><span class="nc">Media</span><span class="p">.</span><span class="nc">IS_PENDING</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>    <span class="c1">// 작업이 끝나면 PENDING을 해제합니다.</span>
<span class="nf">getContentResolver</span><span class="p">().</span><span class="nf">update</span><span class="p">(</span><span class="n">fileUri</span><span class="p">,</span><span class="n">contentValues</span><span class="p">,</span><span class="k">null</span><span class="p">,</span><span class="k">null</span><span class="p">)</span>
</code></pre></div></div>

<p>애초에 파일 생성을 <code class="language-plaintext highlighter-rouge">getContentResolver().insert({Columns}.EXTERNAL_CONTENT_URI, contentValues)</code>로 생성해야합니다. 파일을 생성하면 바로 콘텐츠 프로바이더에서 접근 가능하기 때문에 IO를 고려하며 <code class="language-plaintext highlighter-rouge">IS_PENDING</code>값을 <code class="language-plaintext highlighter-rouge">1</code>로 우선 insert하고 완료되면 <code class="language-plaintext highlighter-rouge">0</code>으로 업데이트합니다. 컨텐츠가 저장되는 폴더는 {Columns}.RELATIVE_PATH에 값을 적절한 값을 넣어주면 됩니다.</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Columns</th>
      <th>RELATIVE_PATH</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>이미지</td>
      <td>MediaStore.Images.Media</td>
      <td>Environment.DIREC TORY_PICTURES <br />Environment.DIRECTORY_DCIM</td>
    </tr>
    <tr>
      <td>영상</td>
      <td>MediaStore.Video.Media</td>
      <td>Environment.DIRECTORY_MOVIES</td>
    </tr>
    <tr>
      <td>음악</td>
      <td>MediaStore.Audio.Media</td>
      <td>Environment.DIRECTORY_MUSIC</td>
    </tr>
    <tr>
      <td>다운로드</td>
      <td>MediaStore.Downloads</td>
      <td>Environment.DIRECTORY_DOWNLOADS</td>
    </tr>
  </tbody>
</table>

<p><a href="https://developer.android.com/training/data-storage/shared/media?hl=ko#toggle-pending-status">https://developer.android.com/training/data-storage/shared/media?hl=ko#toggle-pending-status</a></p>

<h3 id="실제-사용-예">실제 사용 예</h3>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// res/raw폴더에 source파일을 추가하고 실행하면 실제로 동작하는 코드입니다. </span>
<span class="kd">val</span> <span class="py">audioCollection</span> <span class="p">=</span> <span class="nc">MediaStore</span><span class="p">.</span><span class="nc">Audio</span><span class="p">.</span><span class="nc">Media</span>
        <span class="p">.</span><span class="nf">getContentUri</span><span class="p">(</span><span class="nc">MediaStore</span><span class="p">.</span><span class="nc">VOLUME_EXTERNAL_PRIMARY</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">songDetails</span> <span class="p">=</span> <span class="nc">ContentValues</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
    <span class="nf">put</span><span class="p">(</span><span class="nc">MediaStore</span><span class="p">.</span><span class="nc">Audio</span><span class="p">.</span><span class="nc">Media</span><span class="p">.</span><span class="nc">DISPLAY_NAME</span><span class="p">,</span> <span class="s">"My Workout Playlist.mp3"</span><span class="p">)</span>
    <span class="nf">put</span><span class="p">(</span><span class="nc">MediaStore</span><span class="p">.</span><span class="nc">Audio</span><span class="p">.</span><span class="nc">Media</span><span class="p">.</span><span class="nc">IS_PENDING</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">val</span> <span class="py">songContentUri</span> <span class="p">=</span> <span class="n">contentResolver</span><span class="p">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">audioCollection</span><span class="p">,</span> <span class="n">songDetails</span><span class="p">)</span><span class="o">!!</span>
<span class="n">contentResolver</span><span class="p">.</span><span class="nf">openFileDescriptor</span><span class="p">(</span><span class="n">songContentUri</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span><span class="o">?.</span><span class="nf">use</span> <span class="p">{</span> <span class="n">pfd</span> <span class="p">-&gt;</span>
    <span class="kd">val</span> <span class="py">inputStream</span> <span class="p">=</span> <span class="n">resources</span><span class="p">.</span><span class="nf">openRawResource</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">source</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">outputStream</span> <span class="p">=</span> <span class="nc">FileOutputStream</span><span class="p">(</span><span class="n">pfd</span><span class="p">.</span><span class="n">fileDescriptor</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">inputStream</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="p">==</span> <span class="p">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
        <span class="n">outputStream</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">inputStream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="n">outputStream</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">songDetails</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
<span class="n">songDetails</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nc">MediaStore</span><span class="p">.</span><span class="nc">Audio</span><span class="p">.</span><span class="nc">Media</span><span class="p">.</span><span class="nc">IS_PENDING</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">contentResolver</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">songContentUri</span><span class="p">,</span> <span class="n">songDetails</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="legacy-external-storage-유지">Legacy External Storage 유지</h3>

<p>기본적으로 targetSdkVersion을 30으로 상향하게 되면 Api level 29에서 제공되었던 <a href="https://developer.android.com/training/data-storage/use-cases#opt-out-scoped-storage">requestLegacyExternalStorage</a> 가 무시됩니다. 하지만 이전 버전에서 획득한 WRITE_EXTERNAL_STORAGE을 “보존” 시켜주는 속성이 추가 되었습니다.</p>

<p>메니페스트 파일에 <a href="https://developer.android.com/reference/android/R.attr#preserveLegacyExternalStorage">preserveLegacyExternalStorage</a> 속성을 true로 추가하여 Scoped Storage가 적용되기전에 생성한 파일들은 앱이 삭제되기전까지 계속 쓰기권한을 유지합니다. 하지만, requestLegacyExternalStorage와 달리 앱을 재설치하는 경우에는 무시됩니다.</p>

<p>주의할 점은 메니페이스트에서 WRITE_EXTERNAL_STORAGE를 제거하거나, WRITE_EXTERNAL_STORAGE를에 maxSdkVersion=28 같은 옵션을 추가하면 LegacyExternalStorage에 대한 권한을 유지 할 수 없습니다.</p>

<p>테스트 절차는 다음과 같습니다.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span><span class="p">.</span> <span class="nc">Environment</span><span class="p">.</span><span class="nf">getExternalStorageDirectory</span><span class="p">()</span><span class="err">경로에</span> <span class="err">파일을</span> <span class="err">추가하는</span> <span class="err">앱준비합니다</span><span class="p">.</span> 
<span class="mi">2</span><span class="p">.</span> <span class="n">target</span><span class="p">/</span><span class="n">compileSdkVersion</span> <span class="mi">29</span><span class="err">이하로</span> <span class="err">빌드합니다</span><span class="p">.</span> <span class="err">버전코드는</span> <span class="nc">X</span><span class="err">입니다</span><span class="p">.</span>  
   <span class="p">(</span><span class="mi">29</span><span class="err">인</span> <span class="err">경우에는</span> <span class="err">메니페스트에</span> <span class="n">requestLegacyExternalStorage</span><span class="p">=</span><span class="k">true</span><span class="p">)</span>
<span class="mi">3</span><span class="p">.</span> <span class="err">준비된</span> <span class="err">단말기에</span> <span class="mi">2</span><span class="err">의</span> <span class="err">앱을</span> <span class="err">설치</span> <span class="err">및</span> <span class="err">실행합니다</span><span class="p">.</span>
<span class="mi">4</span><span class="p">.</span> <span class="err">앱의</span> <span class="err">권한중</span> <span class="nc">WRITE_EXTERNAL_STORAGE</span><span class="err">를</span> <span class="err">허용합니다</span><span class="p">.</span>
<span class="mi">5</span><span class="p">.</span> <span class="err">앱을</span> <span class="err">통해</span> <span class="err">파일을</span> <span class="err">생성합니다</span><span class="p">.</span>
<span class="mi">6</span><span class="p">.</span> <span class="err">동일한</span> <span class="err">앱의</span> <span class="err">빌드환경을</span> <span class="n">target</span><span class="p">/</span><span class="n">compileSdkVersion</span><span class="err">는</span> <span class="mi">30</span><span class="err">으로</span><span class="p">,</span> <span class="err">버전코드는</span> <span class="nc">X</span><span class="p">+</span><span class="err">로</span> <span class="err">변경후</span> <span class="err">다시</span> <span class="err">빌드합니다</span><span class="p">.</span>  
   <span class="p">(</span><span class="nc">WRITE_EXTERNAL_STORAGE</span><span class="err">를</span> <span class="err">제거</span> <span class="err">해선</span> <span class="err">안됩니다</span><span class="p">.)</span>
<span class="mi">7</span><span class="p">.</span> <span class="mi">6</span><span class="err">의</span> <span class="err">앱을</span> <span class="err">설치</span><span class="p">,</span> <span class="err">실행합니다</span><span class="p">.</span>
<span class="mi">8</span><span class="p">.</span> <span class="err">앱을</span> <span class="err">통해</span> <span class="err">파일을</span> <span class="err">업데이트</span><span class="p">,</span> <span class="err">추가가</span> <span class="err">잘</span> <span class="err">되는지</span> <span class="err">확인</span> <span class="err">합니다</span><span class="p">.</span> 
</code></pre></div></div>


                </div>
            </section>

            <!-- Email search form at the bottom of the page -->
            
                <section class="search-form">
                    <h3 class="search-form-title">Search</h3>
                    <p>Get more post</p>
                    <span id="searchform" method="post" action="/search/" class="">
    <input class="confirm" type="hidden" name="confirm"  />
    <input class="location" type="hidden" name="location"  />
    <input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="search-email" onkeyup="myFunc()"
               id="searchtext" type="text" name="searchtext"
               placeholder="keyword" />
    </div>
    <script type="text/javascript">
        function myFunc() {
            if(event.keyCode == 13) {
                var url = encodeURIComponent($("#searchtext").val());
                location.href = "/search.html?query=" + url;
            }
        }
    </script>
</span>
                </section>
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/logo/normal.png" alt="mond" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/mond">jisoo Yang</a></h4>
                                
                                    <p>Android application developer @ Kakao</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/mond">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://mond-al.github.io/scoped-storage';
                            this.page.identifier = '/scoped-storage';
                            this.page.title = 'Scoped Storage 적용하기';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://mond-al.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/sky.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; 몬드의 개발로그 &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/android/">Android</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/viewpager-fragment">FragmentPagerAdapter, FragmentStatePagerAdapter (생성자 Behavior편)</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/architecture-base-2">아키텍처와 클린코드 그리고 TDD (2)</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/architecture-base-1">아키텍처와 클린코드 그리고 TDD (1)</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/android/">
                                
                                    See all 11 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/file-write">
                <div class="post-card-image" style="background-image: url(/assets/images/cover/common_android.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/file-write">
                <header class="post-card-header">
                    
                        
                            
                               <span class="post-card-tags">Android</span>
                            
                        
                            
                               <span class="post-card-tags">File</span>
                            
                        
                            
                                <span class="post-card-tags">Scoped storage</span>
                            
                        
                    

                    <h2 class="post-card-title">안드로이드 파일 쓰기</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/logo/normal.png" alt="jisoo Yang" />
                        
                        <span class="post-card-author">
                            <a href="/author/mond/">jisoo Yang</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/error-log-android-11-api-changed">
                <div class="post-card-image" style="background-image: url(/assets/images/cover/common_error_log.png)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/error-log-android-11-api-changed">
                <header class="post-card-header">
                    
                        
                            
                               <span class="post-card-tags">Android</span>
                            
                        
                            
                               <span class="post-card-tags">Error</span>
                            
                        
                            
                                <span class="post-card-tags">Log</span>
                            
                        
                    

                    <h2 class="post-card-title">java.lang.NoSuchMethodError No virtual method log(ILjava/lang/String;Ljava/lang/Throwable</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/logo/normal.png" alt="jisoo Yang" />
                        
                        <span class="post-card-author">
                            <a href="/author/mond/">jisoo Yang</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://mond-al.github.io/">
            
                <img src="/assets/images/logo/black_diver_icon.png" alt="몬드의 개발로그 icon" />
            
            <span>몬드의 개발로그</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Scoped Storage 적용하기</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Scoped+Storage+%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0&amp;url=https://mond-al.github.io/scoped-storage"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://mond-al.github.io/scoped-storage"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://mond-al.github.io/">몬드의 개발로그</a> &copy; 2021</section>
            </div>
        </footer>

    </div>

    
    <div id="search" class="search-overlay">
        <a class="search-overlay-close" href="#"></a>
        <div class="search-overlay-content">
            
            <img class="search-overlay-logo"
                 src="/assets/images/logo/normal_icon.png"
                 alt="몬드의 개발로그" />
            
            <h1 class="search-overlay-title">Search <br>$ grep -in "{keyword}" ./log.txt</h1>
            <p class="search-overlay-description">   </p>
            <span id="searchform" method="post" action="/search/" class="">
    <input class="confirm" type="hidden" name="confirm"  />
    <input class="location" type="hidden" name="location"  />
    <input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="search-email" onkeyup="myFunc()"
               id="searchtext" type="text" name="searchtext"
               placeholder="keyword" />
    </div>
    <script type="text/javascript">
        function myFunc() {
            if(event.keyCode == 13) {
                var url = encodeURIComponent($("#searchtext").val());
                location.href = "/search.html?query=" + url;
            }
        }
    </script>
</span>
        </div>
    </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js" integrity="sha512-9GIHU4rPKUMvNOHFOer5Zm2zHnZOjayOO3lZpokhhCtgt8FNlNiW/bb7kl0R5ZXfCDVPcQ8S4oBdNs92p5Nm2w==" crossorigin="anonymous"></script>


    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GGKL7TBGBY"></script>
<script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());
 gtag('config', 'G-GGKL7TBGBY');
</script>

    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
